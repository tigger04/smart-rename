#!/usr/bin/env bash
# ABOUTME: Smart file renaming using AI to generate descriptive filenames
# ABOUTME: Simple, focused implementation that actually works

set -euo pipefail

VERSION="3.0.0"

# Simple function to process a file
process_file() {
    local file="$1"
    local content=""

    # Read file content (first 5000 chars)
    content=$(head -c 5000 "$file" 2>/dev/null) || {
        echo "Error reading file: $file" >&2
        return 1
    }

    if [[ -z "$content" ]]; then
        echo "File is empty: $file" >&2
        return 1
    fi

    # Build prompt
    local prompt="Generate a concise, descriptive filename for this content (no extension, lowercase, use hyphens): $content"

    # Try to get AI response
    local new_name=""

    # Try Ollama if available
    if command -v ollama >/dev/null 2>&1; then
        echo "Using Ollama..." >&2
        new_name=$(echo "$prompt" | timeout 30 ollama run mistral 2>/dev/null | head -1) || true
    fi

    # Try OpenAI if we have a key and no response yet
    if [[ -z "$new_name" && -n "${OPENAI_API_KEY:-}" ]]; then
        echo "Using OpenAI..." >&2
        local json_payload=$(jq -n --arg p "$prompt" '{
            model: "gpt-4o-mini",
            messages: [{role: "user", content: $p}],
            max_tokens: 50
        }')

        new_name=$(curl -s --max-time 30 https://api.openai.com/v1/chat/completions \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$json_payload" | jq -r '.choices[0].message.content // empty' | head -1) || true
    fi

    if [[ -z "$new_name" ]]; then
        echo "Error: Could not generate filename (no AI service available)" >&2
        return 1
    fi

    # Clean the name
    new_name=$(echo "$new_name" | tr -d '"' | tr ' ' '-' | tr -cd '[:alnum:]-' | tr '[:upper:]' '[:lower:]')

    # Add extension
    local ext="${file##*.}"
    if [[ "$ext" != "$file" ]]; then
        new_name="${new_name}.${ext}"
    fi

    echo "Generated name: $new_name" >&2

    # Rename the file
    if [[ -e "$new_name" ]]; then
        echo "File already exists: $new_name" >&2
        return 1
    fi

    mv "$file" "$new_name" && echo "Renamed: $file -> $new_name"
}

# Main
if [[ $# -eq 0 ]]; then
    echo "Usage: $0 <file>"
    exit 1
fi

# Load API keys from environment or config
if [[ -f "$HOME/.config/smart-rename/config.yaml" ]] && command -v yq >/dev/null 2>&1; then
    key=$(yq eval '.api.openai.key // ""' "$HOME/.config/smart-rename/config.yaml" 2>/dev/null)
    [[ -n "$key" ]] && export OPENAI_API_KEY="$key"
fi

process_file "$1"